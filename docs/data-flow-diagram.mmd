sequenceDiagram
    participant U as User/AI Assistant
    participant H as HTTP Transport
    participant M as MCP Server
    participant TH as Tool Handler
    participant SEC as Security Layer
    participant TM as Tools Manager
    participant DB as Database Tools
    participant CON as Database Connection
    participant MySQL as DevLake MySQL

    U->>H: Natural Language Query<br/>"Show incidents from October"
    H->>M: MCP Protocol Request
    M->>TH: Route to Tool Handler
    TH->>SEC: Validate Query Security
    
    alt Security Valid
        TH->>TM: Call Tool: execute_query
        TM->>DB: Execute query tool
        DB->>CON: Validate & Prepare SQL
        
        CON->>MySQL: SELECT * FROM incidents WHERE...
        MySQL-->>CON: Query Results
        
        CON-->>DB: Structured Data
        DB->>SEC: Mask Sensitive Data
        SEC-->>DB: Masked Results
        
        DB-->>TM: JSON Response
        TM-->>TH: Tool Result
        TH-->>M: Processed Result
        M-->>H: MCP Response
        H-->>U: Formatted Results
    else Security Invalid
        SEC-->>TH: Validation Failed
        TH-->>M: Error Response
        M-->>H: Security Error
        H-->>U: Access Denied
    end

